<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-developers/smart_contracts_overview">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.21">
<link rel="alternate" type="application/rss+xml" href="/yield-docs/blog/rss.xml" title="Yield Protocol RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/yield-docs/blog/atom.xml" title="Yield Protocol Atom Feed"><title data-rh="true">Smart Contracts Overview | Yield Protocol</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://iamsahu.github.io/yield-docs/developers/smart_contracts_overview"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Smart Contracts Overview | Yield Protocol"><meta data-rh="true" name="description" content="The vault-v2 repository contains the contracts that enable Yield v2 as a Collateralized Debt Platform. Together, these contracts allow users to post collateral and borrow fyToken, while the protocol takes care of topics such as accounting, collateralization, redemption and liquidations."><meta data-rh="true" property="og:description" content="The vault-v2 repository contains the contracts that enable Yield v2 as a Collateralized Debt Platform. Together, these contracts allow users to post collateral and borrow fyToken, while the protocol takes care of topics such as accounting, collateralization, redemption and liquidations."><link data-rh="true" rel="icon" href="/yield-docs/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://iamsahu.github.io/yield-docs/developers/smart_contracts_overview"><link data-rh="true" rel="alternate" href="https://iamsahu.github.io/yield-docs/developers/smart_contracts_overview" hreflang="en"><link data-rh="true" rel="alternate" href="https://iamsahu.github.io/yield-docs/developers/smart_contracts_overview" hreflang="x-default"><link rel="stylesheet" href="/yield-docs/assets/css/styles.05417fc2.css">
<link rel="preload" href="/yield-docs/assets/js/runtime~main.63152b99.js" as="script">
<link rel="preload" href="/yield-docs/assets/js/main.b74bad32.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/yield-docs/"><div class="navbar__logo"><img src="/yield-docs/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/yield-docs/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">YieldProtocol</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/yield-docs/">Documentation</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/yieldprotocol" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/yield-docs/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/yield-docs/developers/">Developer Documentation</a><button aria-label="Toggle the collapsible sidebar category &#x27;Developer Documentation&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/yield-docs/developers/addresses">Contract Addresses and Asset Identifiers</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/yield-docs/developers/contracts/Cauldron">contracts</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/yield-docs/developers/emergencies">Emergencies</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/yield-docs/developers/governance">Governance</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/yield-docs/developers/smart_contracts_overview">Smart Contracts Overview</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/yield-docs/governance/">Governance</a><button aria-label="Toggle the collapsible sidebar category &#x27;Governance&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/yield-docs/operations/code_reviews">operations</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/yield-docs/troubleshooting">Troubleshooting</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/yield-docs/users/">User Documentation</a><button aria-label="Toggle the collapsible sidebar category &#x27;User Documentation&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_GujU"><div class="docItemContainer_Adtb"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/yield-docs/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/yield-docs/developers/"><span itemprop="name">Developer Documentation</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Smart Contracts Overview</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_aoJ5"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Smart Contracts Overview</h1><p><img loading="lazy" src="/yield-docs/assets/images/architecture-ac6f828597ab0f42f4f0710e7e89a0f3.png" width="1300" height="915" class="img_ev3q"></p><h1>Vault Contracts</h1><p>The vault-v2 repository contains the contracts that enable Yield v2 as a Collateralized Debt Platform. Together, these contracts allow users to post collateral and borrow fyToken, while the protocol takes care of topics such as accounting, collateralization, redemption and liquidations.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="oracle">Oracle<a class="hash-link" href="#oracle" title="Direct link to heading">​</a></h2><p>The Yield Protocol uses its own Oracle interface as a wrapper to external oracles, so that it is possible to switch to external oracles with arbitrary interfaces with no impact on the core contracts.</p><p>The IOracle interface offers a <code>get(bytes32 base, bytes32 quote, uint256 amount) returns (uint256 value)</code> function that accepts base and quote identifiers and an amount of <code>base</code> to convert according to them and to the value returned by the external oracle.</p><p><code>peek</code> is the same as <code>get</code>, but for oracles that offer non-transactional readings.</p><p>Each oracle stores multiple sources of the same type in a single contract, to reduce deployment costs.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="spot-oracles">Spot oracles<a class="hash-link" href="#spot-oracles" title="Direct link to heading">​</a></h3><p>Spot oracles return the <code>value</code> of an <code>amount</code> of <code>base</code> in <code>quote</code> terms. We use these to determine the collateralization level of vaults.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="rate-and-chi-oracles">Rate and chi oracles<a class="hash-link" href="#rate-and-chi-oracles" title="Direct link to heading">​</a></h3><p>To charge borrowers for maintaining a borrowing position after maturity, Yield charges interest. The interest is determined by an oracle called the ‘rate’ oracle. Likewise, to compensate lenders who leave fyTokens unredeemed, fyTokens increase in redemption value after maturity based upon an oracle called the ‘chi’ oracle.</p><p>Rate and chi oracles return the <code>value</code> of an <code>amount</code> multiplied by the borrowing and lending rates for <code>base</code>, respectively. These rates we currently get from Compound cTokens. We use these oracles to determine the debt of vaults after maturity, and the redemption value of fyToken after maturity.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="join">Join<a class="hash-link" href="#join" title="Direct link to heading">​</a></h2><p>Join contracts hold ERC20 and other assets that are external to the Yield Protocol, but that we manage as collateral or underlying.</p><p>We deploy one Join for each asset (collateral or underlying) that is accepted in the Yield Protocol. The Ladle keeps a registry of these Joins and is the only contract or account with permissions to move assets in or out of a Join.</p><p>The Join contract keeps track of the assets it should be holding, instead of relying on checking its balance at the asset contract. This allows removing the need for approvals in the integration with other contracts.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="join-1">Join<a class="hash-link" href="#join-1" title="Direct link to heading">​</a></h3><p>The <code>join</code> function takes assets from the specified account. If there are any unaccounted assets already in the Join, these are used before transferring from the user.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="exit">Exit<a class="hash-link" href="#exit" title="Direct link to heading">​</a></h3><p>Transfer an amount of asset to the given address.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="retrieve">Retrieve<a class="hash-link" href="#retrieve" title="Direct link to heading">​</a></h3><p>Transfer an amount of any ERC20 other than asset to the given address, to enable airdrops to the Join.</p><p>Flash Loans</p><p>The Join can serve as a lender for ERC3156 compliant flash loans of the asset it holds.</p><p>Join Factory</p><p>To reduce the deployment size of Wand to under 24Kb, Joins are deployed through a Join Factory.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="fytoken">FyToken<a class="hash-link" href="#fytoken" title="Direct link to heading">​</a></h2><p>fyTokens are Ethereum based ERC-20 tokens that can be redeemed for an underlying asset one-to-one after a predetermined maturity date.</p><p>Redemptions can be executed at or after maturity. In a redemption, the fyTokens will be burnt and the underlying asset will be sent to a user on a one-to-one basis.</p><p>The fyTokens for redemption needs to either have been approved by the caller or needs to have been transferred to the fyToken contract. If transferring, the <code>transfer</code> and the <code>redeem</code> should happen in the same transaction.</p><p>On the first redemption or the first time that <code>mature</code> is called, the chi oracle is read to record the chi value at maturity. On any subsequent redemptions, the chi oracle is read to calculate the chi accrual, defined as <code>current chi / chi at maturity</code>.</p><p>The amount of underlying transferred on redemption is the amount of fyToken redeemed multiplied by the chi accrual.</p><p>On redemption, fyToken instructs the Join for the underlying to transfer the underlying to the target account.</p><p>The <code>mint</code> and <code>burn</code> functions are restricted, and only the Ladle can call them. It does so when issuing or repaying debt.</p><p>Can be flash minted with no fees following the ERC3156 standard.</p><p>For a given underlying asset, such as Dai, there would be a fyToken contract for each maturity. If, for example, we decide to have quarterly maturities for Dai in 2021, we would deploy 4 fyDai contracts: 31/03/21, 30/06/21, 30/09/21, and 31/12/21.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="cauldron">Cauldron<a class="hash-link" href="#cauldron" title="Direct link to heading">​</a></h2><p>The Cauldron is the debt and collateral accounting system for Yield. The only external dependencies from Cauldron are towards rate oracles and spot oracles. All transactional functions in Cauldron require privileged access.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="vaults">Vaults<a class="hash-link" href="#vaults" title="Direct link to heading">​</a></h3><p>User debt and collateral are recorded in numbered vaults so that each account can have multiple independent positions. A series of fyToken is a specific ERC-20 contract that has a maturity time and an underlying or “base” asset. Vaults permit an owner to provide a single kind of collateral to borrow a single series of fyTokens. Vaults can be created, modified, transferred, or destroyed.</p><p>Each vault is linked to a single series and a single ilk. A series is a fyToken contract with associated data. An ilk is an asset that is used as collateral.</p><p>The vault data is divided into two separate structs, both accessible through the vaultId: Vault and Balances.</p><p>DataTypes.Vault records the owner, seriesId and ilkId.</p><p>DataTypes.Balances record the vault debt(art) and vault collateral(ink). You use ink to draw art.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="stir-and-pour">Stir and pour<a class="hash-link" href="#stir-and-pour" title="Direct link to heading">​</a></h3><p><code>stir</code> moves collateral and debt between vaults. It can only move debt or collateral between vaults with matching seriesId or ilkId, respectively.</p><p>It can be combined with <code>build</code> and <code>destroy</code> to split and merge vaults.</p><p><code>pour</code> is used to add and remove debt and collateral to vaults. It underpins borrowing and repaying.</p><p><code>stir</code> and <code>pour</code> will revert if any affected vaults would be undercollateralized at the end of the transaction.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="debt-after-maturity">Debt after maturity<a class="hash-link" href="#debt-after-maturity" title="Direct link to heading">​</a></h3><p>The debt of a vault is stored in fyToken terms, and only ever changes through user action.</p><p>However, if the debt is expressed in underlying assets, it increases after maturity through applying a borrowing rate obtained from the rate oracle for the underlying.</p><p>A different way to look at this mechanism</p><ul><li>1 fyDai of debt can always be repaid with 1 fyDai</li></ul><ul><li>1 fyDai of debt can be paid with 1 Dai before maturity, or 1 Dai * rate_accrual after maturity, where <code>rate_accrual = borrowing_rate_now / borrowing_rate_at_maturity</code></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="collateralization">Collateralization<a class="hash-link" href="#collateralization" title="Direct link to heading">​</a></h3><p>All vaults need to remain collateralized, or they will be at risk of liquidation.</p><p>A vault is collateralized if the value of its collateral is greater than the value of its debt by a factor equal to the collateralization ratio of the underlying and collateral pair.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ink * price * ratio &gt;= art * rate_accrual</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="liquidations">Liquidations<a class="hash-link" href="#liquidations" title="Direct link to heading">​</a></h3><p>For the protocol to not go bankrupt, it must act when the value of the collateral in the vaults risks being lower than the debt owed by the vaults.</p><p>Liquidation engines are given access to the Cauldron to resolve the situation. Any undercollateralized vault can be seized by a liquidation engine using <code>grab</code>. At that point, the vault effectively belongs to the liquidation engine.</p><p>As the auction proceeds, the liquidation engine will use <code>settle</code> to send any obtained underlying to the appropriate Join, and the sold collateral to the auction buyers.</p><p>Once all the debt is sold, the liquidation engine will return the vault to its owner, with the debt reset to zero, and an amount of collateral that depends on the outcome of the auction.</p><p>Liquidation engines can have multiple implementations, but they must be approved by the Cauldron before they can operate.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="protocol-debt">Protocol Debt<a class="hash-link" href="#protocol-debt" title="Direct link to heading">​</a></h3><p>The Cauldron also records the protocol debt (DataTypes.Debt.debt) for every underlying and collateral pair.</p><p>As users borrow from a given series, the debt is accounted in the protocol totals as the underlying from the series and the collateral that was used.</p><p>There are ceiling debt limits (DataTypes.Debt.max), and the Cauldron will reject registering any more debt that surpasses them.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="witch">Witch<a class="hash-link" href="#witch" title="Direct link to heading">​</a></h2><p>The Witch is a Liquidation Engine, one of many possible implementations.</p><p>The Witch grabs uncollateralized vaults, replacing the owner by itself. Then it sells the vault collateral in exchange for underlying to pay its debt. The amount of collateral given increases over time, until it offers to sell all the collateral for underlying to pay all the debt. The auction is held open at the final price indefinitely.</p><p>After the debt is settled, the Witch returns the vault to its original owner.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ladle">Ladle<a class="hash-link" href="#ladle" title="Direct link to heading">​</a></h2><p>The Ladle is a routing and asset management contract for Yield. It can be upgraded through Modules or replaced entirely. It has considerable privileges and is the most complex contract in the protocol.</p><p>The Ladle is authorized to make changes to the accounting in Cauldron. It is as well the only contract that is authorized to create, modify or destroy Vaults in the Cauldron.</p><p>The Ladle keeps a registry of all Joins and it is authorized to move assets from any Join to any account. The Ladle also moves assets from users to Joins, with allowances approved by the users.</p><p>The Ladle is authorized to mint fyToken at will. The Ladle also moves fyToken from users to FYToken contracts for burning, with allowances approved by the users. The Ladle knows about all the existing fyTokens through the series registry in the Cauldron.</p><p>The Ladle keeps a registry of all the Pools, indexed by the id of the series traded. The Ladle also moves assets from users to Pool contracts for trading, with allowances approved by the users.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="execution-flow">Execution Flow<a class="hash-link" href="#execution-flow" title="Direct link to heading">​</a></h3><p>Any number of actions can be batched in a single transaction using the Ladle using <code>batch</code>. This is the most common method of operation.</p><p>The Ladle can also be used to execute arbitrary calls on any registered contracts using <code>route</code>. This is used, for example, to deal with Pools and Strategies.</p><p>The Ladle can be extended by the use of modules. The Ladle can <code>moduleCall</code> functions in modules that have been authorized via governance. The Modules can inherit from LadleStorage to read and modify the Ladle storage, although modifying it is discouraged.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="user-features">User Features<a class="hash-link" href="#user-features" title="Direct link to heading">​</a></h3><p>The Ladle uses the integrations and authorizations described above to provide collateralized debt features.</p><p>When a user wants to deposit collateral and borrow a fyToken, the Ladle will <code>pour</code>:</p><ol><li>Take the collateral from the user to the appropriate Join.</li><li>Register the position in the Cauldron.</li><li>Mint the fyToken in the user’s account.</li></ol><p>Similarly, a user can repay debt and withdraw collateral with <code>pour</code>.</p><ol><li>Take the fyToken from the user, and burn it.</li><li>Register the new position in the Cauldron.</li><li>Transfer the collateral from the Join to the user.</li></ol><p>Users can also pay their debt with the underlying asset for the debt, instead of with fyTokens, using <code>close</code>. While the debt in fyToken terms only changes through borrowing actions, the debt in underlying terms changes according to the matching rate oracle. The Ladle will get the rate accrual from the oracle through the Cauldron, and adjust asset transfers, and record positions accordingly.</p><p>Users can move collateral and debt between Vaults through the Ladle using <code>stir</code>. Combined with the creation and destruction of Vaults, this can be used to split a Vault in two or to merge two Vaults into one.</p><p><em>Other Features</em></p><ul><li><em>Serve</em>: Borrow and trade the fyToken for underlying, effectively borrowing at a fixed rate.</li><li><em>Roll</em>: Migrate debt between two series.</li><li><em>Repay</em>: Trade underlying for fyToken, to pay the debt.</li><li><em>Repay Vault</em>: Trade underlying for fyToken, to pay exactly all the debt in a vault.</li><li><em>RepayFromLadle</em>: Use any existing fyToken in the Ladle to repay debt.</li><li><em>CloseFromLadle</em>: Use any existing base in the Ladle to repay debt.</li><li><em>Redeem</em>: Redeem fyToken in a fyToken contract for underlying.</li><li><em>Transfer</em>: Take tokens from the caller to a destination.</li><li><em>Permit management</em>: Execute a Dai or ERC2162 off-chain permit.</li><li><em>Ether management</em>: Convert to WETH, or from WETH.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="wand">Wand<a class="hash-link" href="#wand" title="Direct link to heading">​</a></h2><p>Bundling of discrete governance actions into useful governance features.</p><p><em>Add asset</em>: Adding an asset involves registering it in the Cauldron, deploying a Join for it, registering the Join in the Ladle, and permissioning the Ladle to use the Join.
<em>Make base</em>: Making a base out of an existing asset involves setting an oracle for its borrowing rate in the Cauldron, and allowing the Witch to put base into its join during liquidations.
<em>Make ilk</em>: Making an ilk out of an existing asset, for a given base, involves setting a spot oracle for the base/ilk pair in the Cauldron, setting debt limits in the Cauldron, and allowing the Witch to take such ilk out of its Join during liquidations.
<em>Add series</em>: Adding a series is a costly process in terms of gas. It involves deploying the related fyToken, registering it in the Cauldron, and approving a number of ilks to be used as collateral when borrowing it. The fyToken also need to be given access to the Join for its underlying. The Ladle must be given permission to mint and burn the added fyToken. A Pool to trade between the fyToken and its underlying must be deployed, and registered in the Ladle.</p><h1>YieldSpace</h1><p>YieldSpace is an automated liquidity provider that is designed to enable efficient trading between fyTokens and their underlying assets. You can read more about it in our <a href="https://yield.is/YieldSpace.pdf" target="_blank" rel="noopener noreferrer">YieldSpace Whitepaper</a> to get a deeper understanding of the calculations and the overall mechanism. The Yield App integrates YieldSpace seamlessly into the user experience.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="math64x64">Math64x64<a class="hash-link" href="#math64x64" title="Direct link to heading">​</a></h3><p>YieldSpace uses ABDK&#x27;s Math64x64 library, which we have upgraded to 0.8.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="yieldmath">YieldMath<a class="hash-link" href="#yieldmath" title="Direct link to heading">​</a></h3><p>YieldMath.sol uses Math64x64 to implement YieldSpace as described in the whitepaper. The functions implemented in YieldMath are buyBase, sellBase, buyFYToken and sellFYToken.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="pool">Pool<a class="hash-link" href="#pool" title="Direct link to heading">​</a></h2><p>The Pool contracts are a DEX implementation very much in the style of Uniswap v2, but using YieldMath to calculate the trades.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="liquidity">Liquidity<a class="hash-link" href="#liquidity" title="Direct link to heading">​</a></h3><p>Each Pool must keep a balance of the two assets it trades: One underlying asset and one fyToken. The marginal interest rate currently offered by the Pool is determined from the relative levels of the reserves of the underlying asset and the fyToken.</p><p>To build up these balances, liquidity providers can provide assets using <code>mint</code>, receiving pool tokens in exchange. Pool token holders can <code>burn</code> them to receive their assets back, plus a proportion of the pool growth that can be attributed to trading fees.</p><p>When providing liquidity, assets must be provided in the same proportion as the pool balances, thus a liquidity provider is required to provide precise amounts of underlying and fyToken. When a Pool has exactly zero fyToken, only underlying is provided to <code>mint</code>. This is the state when a Pool is first deployed. The initial fyToken balance must come from someone selling fyToken to the Pool.</p><p>In a Pool, the fyToken balances must always be higher than the underlying balances for the curve not to go into negative territory. This means that there are always some fyTokens that cannot be purchased. An optimization already present in Yield v1 is that the supply of pool tokens is added to the fyToken balance when trading. These “virtual fyTokens”  allow us to safely reduce the amount of fyToken that must be kept in the Pools.</p><p>Since providing both underlying and fyToken is inconvenient, the Pool implements a <code>mintWithBase</code> function that allows the liquidity provider to provide only underlying, and a virtual trade will be done to convert a proportion of the underlying to fyToken inside the same pool. The amount of underlying to trade for fyToken must be calculated off-chain.</p><p>In a similar vein, a <code>burnForBase</code> function allows liquidity providers to burn their pool tokens, and trade the fyToken received for underlying without any additional asset transfers, saving gas.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="trading">Trading<a class="hash-link" href="#trading" title="Direct link to heading">​</a></h3><p>The Pool allows the user to sell assets (underlying or fyToken). In this trade, the amount being sold is known, but not the amount being received. Within the same transaction, <code>sellBasePreview</code> or <code>sellFYTokenPreview</code> can be called to know the exact amount to be received.</p><p>The Pool also allows the user to buy assets. In this trade, the amount being received is known, but not the amount taken by the pool. Within the same transaction, <code>buyBasePreview</code> or <code>.mdbuyFYTokenPreview</code> can be called to know the exact amount to be taken by the Pool.</p><p>It is important to note that the Pool doesn’t directly take any assets from anywhere. The assets must be in the Pool before the call to a trading function for the trade to happen. In the case of calls to <code>buyBase</code> or <code>buyFYToken</code>, where the input amount is not known, the user must either call the appropriate <code>Preview</code> function in the same transaction, to transfer the exact amount to the Pool, or must transfer an amount judged sufficient for the trade to execute, and can call <code>retrieveBase</code> or <code>retrieveFYToken</code> afterwards (but in the same transaction) to recover any surplus.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ts-g1-and-g2">TS, G1, and G2<a class="hash-link" href="#ts-g1-and-g2" title="Direct link to heading">​</a></h3><p>The TS, G1, and G2 parameters determine the trading curve and the trading fees and can be set by the PoolFactory owner via the <code>setParameter</code> function for newly deployed Pools.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="time-weighted-average-rate">Time-Weighted Average Rate<a class="hash-link" href="#time-weighted-average-rate" title="Direct link to heading">​</a></h3><p>Much like Uniswap v2 implements a Time-Weighted Average Price, Yield v2 implements a Time-Weighted Average Rate following the same pattern. Pool balances are stored along with the time that the TWAR was last updated, and the ratio of the cumulative balance. With this, the Pool can be used by external contracts as an Interest Rate Oracle between an underlying and a fyToken.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="poolfactory">PoolFactory<a class="hash-link" href="#poolfactory" title="Direct link to heading">​</a></h2><p>The PoolFactory is a permissioned contract that allows deploying Pools using CREATE2.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="poolextensions">PoolExtensions<a class="hash-link" href="#poolextensions" title="Direct link to heading">​</a></h2><p>The PoolExtensions library includes functions to calculate the trading limits and invariant for a Pool. A PoolExtensionsWrapper is included to be able to call them externally.</p><h1>Strategy</h1><p>The Strategy contracts allow liquidity providers to pool liquidity to the Strategy, which in turn provides liquidity to a YieldSpace Pool. Upon maturity, the Strategy rolls the liquidity to a new Pool at no cost to liquidity providers.</p><p>Liquidity providers mint Strategy tokens with Pool tokens of the pool that the Strategy is currently invested in, and receive a share of Strategy tokens proportional to their investment.</p><p>Liquidity providers can burn Strategy tokens of a proportional share of Pool tokens from the Strategy. These Pool tokens are from the current pool, not necessarily the same that they used to invest.</p><p>If the Strategy is not invested in any Pool, liquidity providers can burn their Strategy tokens for a proportional share of the underlying held by the Strategy.</p><p>A governance action sets the next pool to roll to. This action should be taken by a governor role through a long-delay Timelock, to give investors time to react in case they disagree with the next pool.</p><p>A permissioned <code>startPool</code> function can be called if the Strategy is not currently investing in any pool, to invest in the next pool set by <code>setNextPool</code>.</p><p>After the current pool matures, anyone can call <code>endPool</code> to convert all the Strategy holdings into underlying.</p><h1>Utility Contracts</h1><p>The Yield v2 protocol doesn&#x27;t directly reuse any other smart contract implementations. Any general use smart contracts needed were reimplemented and stored in the yield-utils-v2 repository.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="accesscontrol">AccessControl<a class="hash-link" href="#accesscontrol" title="Direct link to heading">​</a></h2><p>The access control contract was adapted from OpenZeppelin&#x27;s AccessControl.sol and is inherited from most other contracts in the Yield Protocol.</p><p>A role exists implicitly for each function in a contract, with the ROOT role as the admin for the role.</p><p>If the <code>auth</code> modifier is present in a function, access must have been granted to the caller by an account with the admin role for the function role. This admin role will usually be ROOT, but that can be changed.</p><p>An <code>admin</code> modifier exists to restrict functions to accounts bearing the <code>admin</code> role of a given other role. This is not used outside AccessControl.sol.</p><p>An account belonging to the admin role for a function can grant and revoke memberships to the function role.</p><p>The ROOT role is special in that it is its own admin so that any member of ROOT can grant and revoke ROOT permissions on other accounts.</p><p>There is a special LOCK role, that is also an admin of itself, but has no members. By changing the admin role of a function role to LOCK, no further changes can ever be done to the function role membership, except users voluntarily renouncing to the function role.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="erc20-and-erc20permit">ERC20 and ERC20Permit<a class="hash-link" href="#erc20-and-erc20permit" title="Direct link to heading">​</a></h2><p>The Yield Protocol ERC20 contracts borrow heavily from the DS-Token implementation. The ERC2162 extension is taken from WETH10, which was taken in turn from Yield v1.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="timelock">Timelock<a class="hash-link" href="#timelock" title="Direct link to heading">​</a></h2><p>The Yield Protocol uses its own implementation of a Timelock, derived from Compound’s original contract, but inheriting from AccessControl and implementing a different pattern to set the earliest time that an execution can be done.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="emergencybrake">EmergencyBrake<a class="hash-link" href="#emergencybrake" title="Direct link to heading">​</a></h2><p>The EmergencyBrake stores the instructions to remove the orchestration between contracts, which is intended to be used in emergency situations to easily isolate parts of the protocol.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/iamsahu/yield-docs/tree/master/docs/developers/smart_contracts_overview.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_eYIM" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vbeJ"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/yield-docs/developers/governance"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Governance</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/yield-docs/governance/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Governance</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#oracle" class="table-of-contents__link toc-highlight">Oracle</a><ul><li><a href="#spot-oracles" class="table-of-contents__link toc-highlight">Spot oracles</a></li><li><a href="#rate-and-chi-oracles" class="table-of-contents__link toc-highlight">Rate and chi oracles</a></li></ul></li><li><a href="#join" class="table-of-contents__link toc-highlight">Join</a><ul><li><a href="#join-1" class="table-of-contents__link toc-highlight">Join</a></li><li><a href="#exit" class="table-of-contents__link toc-highlight">Exit</a></li><li><a href="#retrieve" class="table-of-contents__link toc-highlight">Retrieve</a></li></ul></li><li><a href="#fytoken" class="table-of-contents__link toc-highlight">FyToken</a></li><li><a href="#cauldron" class="table-of-contents__link toc-highlight">Cauldron</a><ul><li><a href="#vaults" class="table-of-contents__link toc-highlight">Vaults</a></li><li><a href="#stir-and-pour" class="table-of-contents__link toc-highlight">Stir and pour</a></li><li><a href="#debt-after-maturity" class="table-of-contents__link toc-highlight">Debt after maturity</a></li><li><a href="#collateralization" class="table-of-contents__link toc-highlight">Collateralization</a></li><li><a href="#liquidations" class="table-of-contents__link toc-highlight">Liquidations</a></li><li><a href="#protocol-debt" class="table-of-contents__link toc-highlight">Protocol Debt</a></li></ul></li><li><a href="#witch" class="table-of-contents__link toc-highlight">Witch</a></li><li><a href="#ladle" class="table-of-contents__link toc-highlight">Ladle</a><ul><li><a href="#execution-flow" class="table-of-contents__link toc-highlight">Execution Flow</a></li><li><a href="#user-features" class="table-of-contents__link toc-highlight">User Features</a></li></ul></li><li><a href="#wand" class="table-of-contents__link toc-highlight">Wand</a><ul><li><a href="#math64x64" class="table-of-contents__link toc-highlight">Math64x64</a></li><li><a href="#yieldmath" class="table-of-contents__link toc-highlight">YieldMath</a></li></ul></li><li><a href="#pool" class="table-of-contents__link toc-highlight">Pool</a><ul><li><a href="#liquidity" class="table-of-contents__link toc-highlight">Liquidity</a></li><li><a href="#trading" class="table-of-contents__link toc-highlight">Trading</a></li><li><a href="#ts-g1-and-g2" class="table-of-contents__link toc-highlight">TS, G1, and G2</a></li><li><a href="#time-weighted-average-rate" class="table-of-contents__link toc-highlight">Time-Weighted Average Rate</a></li></ul></li><li><a href="#poolfactory" class="table-of-contents__link toc-highlight">PoolFactory</a></li><li><a href="#poolextensions" class="table-of-contents__link toc-highlight">PoolExtensions</a></li><li><a href="#accesscontrol" class="table-of-contents__link toc-highlight">AccessControl</a></li><li><a href="#erc20-and-erc20permit" class="table-of-contents__link toc-highlight">ERC20 and ERC20Permit</a></li><li><a href="#timelock" class="table-of-contents__link toc-highlight">Timelock</a></li><li><a href="#emergencybrake" class="table-of-contents__link toc-highlight">EmergencyBrake</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://discord.gg/JAFfDj5" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/yieldprotocol" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/yieldprotocol" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 YieldProtocol, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/yield-docs/assets/js/runtime~main.63152b99.js"></script>
<script src="/yield-docs/assets/js/main.b74bad32.js"></script>
</body>
</html>